name: CI - Car Inventory Demo

on:
  push:
    branches: ["main"]
  pull_request:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Docker versions
        run: |
          docker --version
          docker compose version

      - name: Build and start services
        run: docker compose up -d --build

      - name: Wait for DB health
        shell: bash
        run: |
          set -euo pipefail
          echo "Waiting for DB container to become healthy..."
          for i in {1..40}; do
            STATUS="$(docker inspect --format='{{.State.Health.Status}}' mssql-container 2>/dev/null || echo starting)"
            echo "DB status: $STATUS"
            if [ "$STATUS" = "healthy" ]; then
              echo "DB is healthy!"
              exit 0
            fi
            sleep 3
          done
          echo "DB did not become healthy in time"
          docker compose ps
          docker compose logs --no-color database
          exit 1

      - name: Wait for db-init to complete successfully
        shell: bash
        run: |
          set -euo pipefail
          echo "Waiting for db-init to finish..."
          for i in {1..40}; do
            STATE="$(docker inspect --format='{{.State.Status}}' db-init 2>/dev/null || echo missing)"
            CODE="$(docker inspect --format='{{.State.ExitCode}}' db-init 2>/dev/null || echo 999)"
            echo "db-init state=$STATE exitCode=$CODE"

            if [ "$STATE" = "exited" ] && [ "$CODE" = "0" ]; then
              echo "db-init succeeded!"
              exit 0
            fi

            if [ "$STATE" = "exited" ] && [ "$CODE" != "0" ]; then
              echo "db-init failed!"
              docker compose logs --no-color db-init database
              exit 1
            fi

            sleep 3
          done

          echo "db-init did not finish in time"
          docker compose logs --no-color db-init database
          exit 1

      - name: Wait for backend readiness
        shell: bash
        run: |
          set -euo pipefail
          echo "Waiting for backend /health/ready..."
          for i in {1..40}; do
            if curl -fsS http://localhost:5000/health/ready > /dev/null; then
              echo "Backend is ready!"
              exit 0
            fi
            sleep 3
          done
          echo "Backend not ready in time"
          docker compose ps
          docker compose logs --no-color backend database db-init
          exit 1

      - name: Integration test - /token and /cars
        shell: bash
        run: |
          set -euo pipefail

          TOKEN="$(curl -fsS http://localhost:5000/token)"
          echo "Got token (length=${#TOKEN})"

          RESP="$(curl -fsS -H "Authorization: Bearer $TOKEN" http://localhost:5000/cars)"
          python - <<'PY'
import json, os
data = json.loads(os.environ["RESP"])
assert isinstance(data, list), f"Expected list, got {type(data)}"
assert len(data) > 0, "Expected seeded cars data"
print(f"OK: received {len(data)} cars")
PY
        env:
          RESP: ${{ '' }} # placeholder to satisfy YAML editors (overwritten by bash)
        # NOTE: GitHub Actions ignores the env above because we set RESP in bash.
        # It is safe to keep as-is.

      - name: Wait for frontend
        shell: bash
        run: |
          set -euo pipefail
          echo "Waiting for frontend..."
          for i in {1..40}; do
            if curl -fsS http://localhost:3000 > /dev/null; then
              echo "Frontend is up!"
              exit 0
            fi
            sleep 3
          done
          echo "Frontend not ready in time"
          docker compose ps
          docker compose logs --no-color frontend
          exit 1

      - name: Show logs on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --no-color

      - name: Shutdown services
        if: always()
        run: docker compose down -v
